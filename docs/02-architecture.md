# æ¶æ„è®¾è®¡

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

Simple Chatbot é‡‡ç”¨ç°ä»£çš„å‰åç«¯ä¸€ä½“åŒ–æ¶æ„ï¼ŒåŸºäº Next.js App Routerã€‚

---

## ğŸ“ æ€»ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser (å®¢æˆ·ç«¯)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Chat Page   â”‚  â”‚   Sidebar    â”‚  â”‚  Auth Pages  â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚ â”‚
â”‚  â”‚  - Messages  â”‚  â”‚  - History   â”‚  â”‚  - Login     â”‚ â”‚
â”‚  â”‚  - Input     â”‚  â”‚  - Switch    â”‚  â”‚  - Register  â”‚ â”‚
â”‚  â”‚  - Header    â”‚  â”‚  - Delete    â”‚  â”‚              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                 â”‚                  â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                           â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP / WebSocket
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           â”‚                             â”‚
â”‚         Next.js Server (æœåŠ¡ç«¯)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           API Routes (App Router)              â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚  - /api/chat (POST) - èŠå¤©æ¥å£ï¼ˆæµå¼ï¼‰         â”‚    â”‚
â”‚  â”‚  - /api/auth/* - è®¤è¯æ¥å£ (NextAuth)           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚               â”‚                       â”‚                â”‚
â”‚               â”‚                       â”‚                â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚       â”‚   AI Provider   â”‚    â”‚   Database      â”‚      â”‚
â”‚       â”‚  (OpenAI, etc)  â”‚    â”‚  (PostgreSQL)   â”‚      â”‚
â”‚       â”‚                 â”‚    â”‚                 â”‚      â”‚
â”‚       â”‚  - Stream Chat  â”‚    â”‚  - Users        â”‚      â”‚
â”‚       â”‚  - Models       â”‚    â”‚  - Chats        â”‚      â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  - Messages     â”‚      â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ•°æ®æµè®¾è®¡

### 1. ç”¨æˆ·å‘é€æ¶ˆæ¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚
â”‚  Input   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1. ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChatInput     â”‚
â”‚  Component     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. è°ƒç”¨ sendMessage()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   useChat      â”‚  â† Vercel AI SDK
â”‚   Hook         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. POST /api/chat
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Route     â”‚
â”‚  /api/chat     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. è°ƒç”¨ AI Provider
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Provider   â”‚
â”‚  (OpenAI)      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. æµå¼è¿”å›
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  useChat       â”‚
â”‚  (æ¥æ”¶æµ)      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. æ›´æ–° messages çŠ¶æ€
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageList   â”‚
â”‚  Component     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 7. æ¸²æŸ“æ¶ˆæ¯
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Message       â”‚
â”‚  Component     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. æ¶ˆæ¯å­˜å‚¨æµç¨‹ï¼ˆPhase 2ï¼‰

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
     â”‚
     â–¼
useChat å‘é€è¯·æ±‚
     â”‚
     â–¼
API Route æ¥æ”¶
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              â”‚
     â–¼              â–¼
è°ƒç”¨ AI        ä¿å­˜åˆ°æ•°æ®åº“
     â”‚              â”‚
     â”‚              â”œâ”€ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
     â–¼              â”‚
æµå¼è¿”å›          â”‚
     â”‚              â”‚
     â–¼              â–¼
onFinish()      ä¿å­˜ AI å›å¤
     â”‚
     â–¼
è§¦å‘ä¾§è¾¹æ åˆ·æ–°
```

---

### 3. ä¼šè¯åˆ‡æ¢æµç¨‹ï¼ˆPhase 2ï¼‰

```
ç”¨æˆ·ç‚¹å‡»ä¾§è¾¹æ ä¼šè¯
     â”‚
     â–¼
router.push('/chat/[id]')
     â”‚
     â–¼
æœåŠ¡ç«¯æ¸²æŸ“
     â”‚
     â”œâ”€ ä»æ•°æ®åº“åŠ è½½æ¶ˆæ¯
     â”‚
     â–¼
è¿”å›åˆå§‹ messages
     â”‚
     â–¼
useChat åˆå§‹åŒ–
     â”‚
     â–¼
MessageList æ¸²æŸ“
```

---

## ğŸ—‚ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### Phase 1: çº¯å†…å­˜çŠ¶æ€ï¼ˆä¸æŒä¹…åŒ–ï¼‰

```typescript
// æ¶ˆæ¯ç»“æ„
interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  createdAt: Date
}

// çŠ¶æ€å­˜å‚¨åœ¨ useChat hook ä¸­
const { messages, sendMessage } = useChat({
  initialMessages: []
})
```

---

### Phase 2: æ•°æ®åº“è®¾è®¡

#### è¡¨ç»“æ„

**1. users è¡¨ï¼ˆPhase 3 æ·»åŠ ï¼‰**
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**2. chats è¡¨**
```sql
CREATE TABLE chats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_chats_user_id ON chats(user_id);
CREATE INDEX idx_chats_created_at ON chats(created_at DESC);
```

**3. messages è¡¨**
```sql
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  chat_id UUID REFERENCES chats(id) ON DELETE CASCADE,
  role VARCHAR(20) NOT NULL CHECK (role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_messages_chat_id ON messages(chat_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);
```

#### Drizzle ORM Schema

```typescript
// lib/db/schema.ts

import { pgTable, uuid, varchar, text, timestamp } from 'drizzle-orm/pg-core'

export const users = pgTable('users', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  passwordHash: varchar('password_hash', { length: 255 }).notNull(),
  name: varchar('name', { length: 255 }),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow()
})

export const chats = pgTable('chats', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').references(() => users.id, { onDelete: 'cascade' }),
  title: varchar('title', { length: 255 }).notNull(),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow()
})

export const messages = pgTable('messages', {
  id: uuid('id').primaryKey().defaultRandom(),
  chatId: uuid('chat_id').references(() => chats.id, { onDelete: 'cascade' }),
  role: varchar('role', { length: 20 }).notNull(), // 'user' | 'assistant'
  content: text('content').notNull(),
  createdAt: timestamp('created_at').defaultNow()
})
```

---

## ğŸ”Œ API è®¾è®¡

### Phase 1: èŠå¤© API

#### POST /api/chat

**è¯·æ±‚ï¼š**
```typescript
{
  messages: Array<{
    id: string
    role: 'user' | 'assistant'
    content: string
  }>
}
```

**å“åº”ï¼š** æµå¼å“åº”ï¼ˆServer-Sent Eventsï¼‰
```
data: {"type":"text","value":"ä½ "}
data: {"type":"text","value":"å¥½"}
data: {"type":"text","value":"ï¼"}
...
data: [DONE]
```

**å®ç°ï¼š**
```typescript
// app/api/chat/route.ts

import { streamText } from 'ai'
import { openai } from '@ai-sdk/openai'

export async function POST(req: Request) {
  const { messages } = await req.json()

  const result = streamText({
    model: openai('gpt-4o'),
    messages,
  })

  return result.toDataStreamResponse()
}
```

---

### Phase 2: èŠå¤©å†å² API

#### GET /api/chats

è·å–ç”¨æˆ·çš„æ‰€æœ‰èŠå¤©ä¼šè¯

**å“åº”ï¼š**
```typescript
{
  chats: Array<{
    id: string
    title: string
    createdAt: string
    updatedAt: string
  }>
}
```

#### GET /api/chats/[id]

è·å–æŒ‡å®šä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯

**å“åº”ï¼š**
```typescript
{
  chat: {
    id: string
    title: string
  },
  messages: Array<{
    id: string
    role: 'user' | 'assistant'
    content: string
    createdAt: string
  }>
}
```

#### DELETE /api/chats/[id]

åˆ é™¤æŒ‡å®šä¼šè¯

**å“åº”ï¼š**
```typescript
{
  success: boolean
}
```

---

### Phase 3: è®¤è¯ API

ä½¿ç”¨ NextAuth.jsï¼Œè‡ªåŠ¨æä¾›ä»¥ä¸‹ç«¯ç‚¹ï¼š

- `POST /api/auth/signin` - ç™»å½•
- `POST /api/auth/signout` - ç™»å‡º
- `GET /api/auth/session` - è·å–ä¼šè¯
- `POST /api/auth/register` - æ³¨å†Œï¼ˆè‡ªå®šä¹‰ï¼‰

---

## ğŸ§© ç»„ä»¶è®¾è®¡

### ç»„ä»¶å±‚æ¬¡ç»“æ„

```
app/
â”œâ”€â”€ layout.tsx (æ ¹å¸ƒå±€)
â”‚   â””â”€â”€ RootLayout
â”‚       â”œâ”€â”€ Sidebar (Phase 2)
â”‚       â”‚   â”œâ”€â”€ SidebarHeader
â”‚       â”‚   â”œâ”€â”€ ChatHistory
â”‚       â”‚   â”‚   â””â”€â”€ ChatHistoryItem (å¤šä¸ª)
â”‚       â”‚   â””â”€â”€ SidebarFooter
â”‚       â””â”€â”€ {children}
â”‚
â”œâ”€â”€ page.tsx (é¦–é¡µ)
â”‚   â””â”€â”€ ChatPage
â”‚       â”œâ”€â”€ ChatHeader
â”‚       â”œâ”€â”€ MessageList
â”‚       â”‚   â””â”€â”€ Message (å¤šä¸ª)
â”‚       â””â”€â”€ ChatInput
â”‚
â””â”€â”€ chat/[id]/page.tsx (ä¼šè¯é¡µé¢ - Phase 2)
    â””â”€â”€ ChatPage (åŒä¸Š)
```

---

### æ ¸å¿ƒç»„ä»¶è¯¦è§£

#### 1. Message ç»„ä»¶

**èŒè´£ï¼š** æ¸²æŸ“å•æ¡æ¶ˆæ¯

**Propsï¼š**
```typescript
interface MessageProps {
  message: {
    id: string
    role: 'user' | 'assistant'
    content: string
  }
}
```

**å…³é”®ç‰¹æ€§ï¼š**
- æ ¹æ® role æ˜¾ç¤ºä¸åŒæ ·å¼ï¼ˆç”¨æˆ·å³å¯¹é½ï¼ŒAI å·¦å¯¹é½ï¼‰
- Markdown æ¸²æŸ“
- ä»£ç å—è¯­æ³•é«˜äº®ï¼ˆPhase 4ï¼‰
- å¤åˆ¶æŒ‰é’®ï¼ˆPhase 4ï¼‰

---

#### 2. MessageList ç»„ä»¶

**èŒè´£ï¼š** æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ï¼Œç®¡ç†æ»šåŠ¨

**Propsï¼š**
```typescript
interface MessageListProps {
  messages: Message[]
}
```

**å…³é”®ç‰¹æ€§ï¼š**
- è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
- è™šæ‹Ÿæ»šåŠ¨ï¼ˆæ¶ˆæ¯å¾ˆå¤šæ—¶ - Phase 4ï¼‰
- åŠ è½½çŠ¶æ€æ˜¾ç¤º

---

#### 3. ChatInput ç»„ä»¶

**èŒè´£ï¼š** å¤„ç†ç”¨æˆ·è¾“å…¥

**Propsï¼š**
```typescript
interface ChatInputProps {
  onSend: (content: string) => void
  isLoading: boolean
}
```

**å…³é”®ç‰¹æ€§ï¼š**
- å¤šè¡Œè¾“å…¥ï¼ˆtextareaï¼‰
- è‡ªåŠ¨é«˜åº¦è°ƒæ•´
- Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
- åœæ­¢ç”ŸæˆæŒ‰é’®ï¼ˆPhase 2ï¼‰
- å­—ç¬¦è®¡æ•°ï¼ˆPhase 4ï¼‰

---

#### 4. ChatHeader ç»„ä»¶

**èŒè´£ï¼š** é¡¶éƒ¨å¯¼èˆªæ 

**ç‰¹æ€§ï¼š**
- æ˜¾ç¤ºä¼šè¯æ ‡é¢˜ï¼ˆPhase 2ï¼‰
- æ–°å»ºä¼šè¯æŒ‰é’®
- ç”¨æˆ·èœå•ï¼ˆPhase 3ï¼‰
- ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’®

---

#### 5. Sidebar ç»„ä»¶ï¼ˆPhase 2ï¼‰

**èŒè´£ï¼š** ä¾§è¾¹æ å¯¼èˆª

**ç‰¹æ€§ï¼š**
- æ˜¾ç¤ºå†å²ä¼šè¯åˆ—è¡¨
- åˆ‡æ¢ä¼šè¯
- åˆ é™¤ä¼šè¯
- æ–°å»ºä¼šè¯
- å“åº”å¼ï¼ˆç§»åŠ¨ç«¯å¯æ”¶èµ·ï¼‰

---

## ğŸ” çŠ¶æ€ç®¡ç†

### Phase 1: æœ¬åœ°çŠ¶æ€ï¼ˆuseChatï¼‰

```typescript
const {
  messages,        // æ¶ˆæ¯åˆ—è¡¨
  input,          // è¾“å…¥æ¡†å†…å®¹
  isLoading,      // åŠ è½½çŠ¶æ€
  sendMessage,    // å‘é€æ¶ˆæ¯
  stop,           // åœæ­¢ç”Ÿæˆï¼ˆPhase 2ï¼‰
} = useChat({
  api: '/api/chat',
  initialMessages: [],
})
```

**ä¼˜ç‚¹ï¼š**
- ç®€å•ç›´æ¥
- Vercel AI SDK å·²å°è£…å¥½
- è‡ªåŠ¨å¤„ç†æµå¼å“åº”

---

### Phase 2: æ•°æ®æŒä¹…åŒ–ï¼ˆSWR + Databaseï¼‰

```typescript
// è·å–èŠå¤©åˆ—è¡¨
const { data: chats, mutate } = useSWR('/api/chats', fetcher)

// åˆ‡æ¢ä¼šè¯æ—¶
const loadChat = async (chatId: string) => {
  const res = await fetch(`/api/chats/${chatId}`)
  const { messages } = await res.json()

  // åˆå§‹åŒ– useChat
  setMessages(messages)
}

// ä¿å­˜æ–°æ¶ˆæ¯
const saveMessage = async (message: Message) => {
  await fetch('/api/messages', {
    method: 'POST',
    body: JSON.stringify(message)
  })

  // åˆ·æ–°ä¾§è¾¹æ 
  mutate()
}
```

---

### Phase 3: è®¤è¯çŠ¶æ€ï¼ˆNextAuthï¼‰

```typescript
const { data: session } = useSession()

// ä¿æŠ¤è·¯ç”±
if (!session) {
  redirect('/login')
}

// è·å–å½“å‰ç”¨æˆ·çš„æ•°æ®
const userId = session.user.id
```

---

## ğŸ¨ æ ·å¼ç³»ç»Ÿ

### Tailwind CSS + CSS å˜é‡

```css
/* globals.css */

:root {
  --background: 0 0% 100%;
  --foreground: 0 0% 3.9%;
  --primary: 221.2 83.2% 53.3%;
  --primary-foreground: 210 40% 98%;
  --muted: 210 40% 96.1%;
  --muted-foreground: 215.4 16.3% 46.9%;
  --border: 214.3 31.8% 91.4%;
  /* ... æ›´å¤šå˜é‡ */
}
```

**ä½¿ç”¨ï¼š**
```tsx
<div className="bg-background text-foreground border-border">
  <button className="bg-primary text-primary-foreground">
    å‘é€
  </button>
</div>
```

**ä¼˜ç‚¹ï¼š**
- æ˜“äºä¸»é¢˜åˆ‡æ¢ï¼ˆPhase 4 æ·»åŠ æ·±è‰²æ¨¡å¼ï¼‰
- ä¸€è‡´çš„é¢œè‰²ç³»ç»Ÿ
- æ˜“äºç»´æŠ¤

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. ä»£ç åˆ†å‰²

```typescript
// åŠ¨æ€å¯¼å…¥
const Sidebar = dynamic(() => import('@/components/sidebar'), {
  loading: () => <SidebarSkeleton />
})
```

### 2. å›¾ç‰‡ä¼˜åŒ–

```typescript
import Image from 'next/image'

<Image
  src="/avatar.png"
  width={32}
  height={32}
  alt="User"
/>
```

### 3. æµå¼æ¸²æŸ“

- ä½¿ç”¨ React Server Components
- ä½¿ç”¨ Suspense è¾¹ç•Œ
- æµå¼è¿”å› AI å“åº”

### 4. ç¼“å­˜ç­–ç•¥ï¼ˆPhase 2ï¼‰

```typescript
// SWR è‡ªåŠ¨ç¼“å­˜
const { data } = useSWR('/api/chats', fetcher, {
  revalidateOnFocus: false,
  dedupingInterval: 60000, // 1 åˆ†é’Ÿå†…ä¸é‡å¤è¯·æ±‚
})
```

---

## ğŸ”’ å®‰å…¨è®¾è®¡

### 1. API ä¿æŠ¤ï¼ˆPhase 3ï¼‰

```typescript
// app/api/chat/route.ts
import { getServerSession } from 'next-auth'

export async function POST(req: Request) {
  const session = await getServerSession()

  if (!session) {
    return new Response('Unauthorized', { status: 401 })
  }

  // ... ç»§ç»­å¤„ç†
}
```

### 2. XSS é˜²æŠ¤

- ä½¿ç”¨ Markdown æ¸²æŸ“åº“çš„å®‰å…¨æ¨¡å¼
- ç¦æ­¢æ¸²æŸ“å±é™©çš„ HTML æ ‡ç­¾
- å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè½¬ä¹‰

### 3. SQL æ³¨å…¥é˜²æŠ¤

- ä½¿ç”¨ Drizzle ORM å‚æ•°åŒ–æŸ¥è¯¢
- ä¸ç›´æ¥æ‹¼æ¥ SQL

### 4. Rate Limitingï¼ˆPhase 4ï¼‰

```typescript
import { ratelimit } from '@/lib/ratelimit'

export async function POST(req: Request) {
  const { success } = await ratelimit.limit(userId)

  if (!success) {
    return new Response('Too many requests', { status: 429 })
  }

  // ... ç»§ç»­å¤„ç†
}
```

---

## ğŸ“¦ éƒ¨ç½²æ¶æ„

### Vercel éƒ¨ç½²ï¼ˆæ¨èï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vercel Edge    â”‚ â† ç”¨æˆ·è¯·æ±‚
â”‚  Network        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js        â”‚
â”‚  Server         â”‚
â”‚  (Serverless)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            â”‚
         â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI API  â”‚  â”‚  PostgreSQL  â”‚
â”‚              â”‚  â”‚  (Vercel)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è‡ªæ‰˜ç®¡éƒ¨ç½²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Nginx       â”‚ â† ç”¨æˆ·è¯·æ±‚
â”‚  (Reverse Proxy)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js        â”‚
â”‚  Server         â”‚
â”‚  (Node.js)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            â”‚
         â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI API  â”‚  â”‚  PostgreSQL  â”‚
â”‚              â”‚  â”‚  (è‡ªæ‰˜ç®¡)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å¯è§‚æµ‹æ€§ï¼ˆPhase 4ï¼‰

### 1. æ—¥å¿—

```typescript
// lib/logger.ts
import { createLogger } from 'winston'

export const logger = createLogger({
  level: 'info',
  format: format.json(),
  transports: [
    new transports.File({ filename: 'error.log', level: 'error' }),
    new transports.File({ filename: 'combined.log' })
  ]
})
```

### 2. ç›‘æ§

- Vercel Analyticsï¼ˆè‡ªåŠ¨ï¼‰
- Sentryï¼ˆé”™è¯¯è¿½è¸ªï¼‰
- PostHogï¼ˆç”¨æˆ·è¡Œä¸ºï¼‰

### 3. æ€§èƒ½è¿½è¸ª

```typescript
import { track } from '@/lib/analytics'

// è¿½è¸ªå…³é”®æ“ä½œ
track('message_sent', {
  chatId,
  messageLength: content.length,
  duration: Date.now() - startTime
})
```

---

## ğŸ”„ æ‰©å±•æ€§è®¾è®¡

### æ’ä»¶ç³»ç»Ÿï¼ˆé¢„ç•™ï¼‰

```typescript
// é¢„ç•™æ’ä»¶æ¥å£
interface Plugin {
  name: string
  onMessageReceived?: (message: Message) => void
  onMessageSent?: (message: Message) => void
  commands?: Command[]
}

// æœªæ¥å¯ä»¥æ·»åŠ 
const plugins = [
  weatherPlugin,
  calculatorPlugin,
  // ... æ›´å¤šæ’ä»¶
]
```

### è‡ªå®šä¹‰æ¨¡å‹ï¼ˆé¢„ç•™ï¼‰

```typescript
// lib/ai/providers.ts

// å½“å‰ï¼šå•ä¸€æ¨¡å‹
export const model = openai('gpt-4o')

// æœªæ¥ï¼šå¯åˆ‡æ¢æ¨¡å‹
export const models = {
  'gpt-4o': openai('gpt-4o'),
  'claude-3': anthropic('claude-3-opus'),
  'qwen': custom('qwen-max'),
}
```

---

**æœ€åæ›´æ–°ï¼š** 2025-11-13
